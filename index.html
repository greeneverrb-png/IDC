<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chord Visualizer & Tempo Sync</title>
<style>
body{margin:0;background:#0b0e1a;color:white;font-family:system-ui,sans-serif}
header{text-align:center;padding:12px;font-size:20px;font-weight:600}
.container{padding:12px;max-width:900px;margin:auto}
.card{background:#151a33;border-radius:14px;padding:14px;margin-bottom:12px}
button,input,select{background:#22286a;border:none;border-radius:10px;color:white;padding:12px;font-size:16px;cursor:pointer}
button:disabled{opacity:.4}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.chords{height:160px;background:#050714;border-radius:12px;display:flex;align-items:center;overflow:hidden;position:relative}
.scroll{display:flex;gap:60px;transition:transform .2s ease}
.chord{font-size:34px;color:#777db8;font-weight:700;transition:all .3s ease}
.chord.active{color:#00e0ff;font-size:64px;font-weight:900;text-shadow:0 0 20px rgba(0,224,255,.8)}
.fullscreen{position:fixed;inset:0;background:black;z-index:999;padding:20px}
.fullscreen .chord{font-size:90px}
.full-controls{position:absolute;top:10px;left:10px;display:flex;gap:10px;z-index:1000}
.time{font-size:12px;color:#aaa;display:flex;justify-content:space-between}
#tempoDisplay{margin-left:10px;font-weight:600}
</style>
</head>
<body>
<header>üé∏ Chord Visualizer & Tempo Sync</header>
<div class="container">
<div class="card">
  <input type="file" id="audioFile" accept=".mp3">
</div>
<div class="card">
  <div class="controls">
    <button id="play" disabled>‚ñ∂Ô∏è</button>
    <strong id="detected">Scale: -</strong>
    <select id="scaleSelect"></select>
    <button id="applyScale">Apply Scale</button>
    <button id="resetScale">Original</button>
    <button id="tempoBtn">Tempo</button>
    <span id="tempoDisplay">- BPM</span>
  </div>
  <input type="range" id="seek" value="0">
  <div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
</div>
<div class="card" id="chordCard">
  <div class="full-controls">
    <button id="fsPlay">‚ñ∂Ô∏è</button>
  </div>
  <div class="chords">
    <div class="scroll" id="scroll"></div>
  </div>
  <button onclick="toggleFull()">‚õ∂ Full</button>
</div>
</div>
<audio id="audio"></audio>
<script>
const audio=document.getElementById('audio');
const audioFile=document.getElementById('audioFile');
const playBtn=document.getElementById('play');
const fsPlayBtn=document.getElementById('fsPlay');
const scroll=document.getElementById('scroll');
const seek=document.getElementById('seek');
const cur=document.getElementById('cur');
const dur=document.getElementById('dur');
const detected=document.getElementById('detected');
const scaleSelect=document.getElementById('scaleSelect');
const applyScaleBtn=document.getElementById('applyScale');
const resetScaleBtn=document.getElementById('resetScale');
const tempoBtn=document.getElementById('tempoBtn');
const tempoDisplay=document.getElementById('tempoDisplay');
const chordCard=document.getElementById('chordCard');

const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
let chords=[], originalChords=[];
let detectedScale='C', currentShift=0;
let tempoActive=false, bpm=0, audioCtx=null, tempoInterval=null;

// populate scale select
NOTES.forEach(n=>{const o=document.createElement('option'); o.value=n; o.textContent=n; scaleSelect.appendChild(o);});

// file upload
audioFile.onchange=e=>{
 const file=e.target.files[0];
 if(!file) return;
 audio.src=URL.createObjectURL(file);
 audio.load();
 chords=[]; originalChords=[]; scroll.innerHTML=''; playBtn.disabled=true;
 detected.textContent='Scale: -'; tempoDisplay.textContent='- BPM'; tempoActive=false;
 clearInterval(tempoInterval);
};

audio.onloadedmetadata=()=>{
 dur.textContent=format(audio.duration);
 playBtn.disabled=false;
 detectRootScale();
 generateChordTimeline();
 detectBPM();
};

// play/pause
function playAudio(){
 if(audio.paused){audio.play(); playBtn.textContent='‚è∏'; fsPlayBtn.textContent='‚è∏';}
 else{audio.pause(); playBtn.textContent='‚ñ∂Ô∏è'; fsPlayBtn.textContent='‚ñ∂Ô∏è';}
}
playBtn.onclick=playAudio;
fsPlayBtn.onclick=playAudio;

// time update
audio.ontimeupdate=()=>{
 seek.value=(audio.currentTime/audio.duration)*100;
 cur.textContent=format(audio.currentTime);
 scrollChords();
};
seek.oninput=()=>audio.currentTime=(seek.value/100)*audio.duration;

// chord scroll & highlight
function scrollChords(){
 if(!chords.length) return;
 const items=[...scroll.children];
 let current=-1;
 for(let i=0;i<chords.length;i++){
  if(audio.currentTime>=chords[i].time) current=i;
  else break;
 }
 if(current<0) return;
 items.forEach(x=>x.classList.remove('active'));
 if(items[current]) items[current].classList.add('active');
 const centerOffset=window.innerWidth/2 - items[current].offsetWidth/2;
 const translateX=-items[current].offsetLeft+centerOffset;
 scroll.style.transform=`translateX(${translateX}px)`;
}

// root scale detect (approximate for demo)
function detectRootScale(){
 const counts = {};
 NOTES.forEach(n=>counts[n]=0);
 chords.forEach(c=>{if(counts[c.chord]!==undefined) counts[c.chord]++});
 const maxChord = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b, 'C');
 detectedScale=maxChord;
 detected.textContent='Scale: '+detectedScale;
 scaleSelect.value=detectedScale;
}

// generate chord timeline (demo approximate)
function generateChordTimeline(){
 chords=[]; scroll.innerHTML='';
 const step=4;
 for(let t=0;t<audio.duration;t+=step){
  const chord=NOTES[Math.floor(Math.random()*NOTES.length)];
  chords.push({time:t,chord:chord});
  const d=document.createElement('div'); d.className='chord'; d.textContent=chord;
  scroll.appendChild(d);
 }
 originalChords=JSON.parse(JSON.stringify(chords));
}

function applyScale(){
 const target=scaleSelect.value;
 const shift=(NOTES.indexOf(target)-NOTES.indexOf(detectedScale)+12)%12;
 currentShift=shift;
 chords=originalChords.map(c=>({time:c.time,chord:transpose(c.chord,shift)}));
 renderChords();
}
function resetScale(){chords=JSON.parse(JSON.stringify(originalChords)); renderChords();}
function transpose(chord,shift){const idx=NOTES.indexOf(chord);if(idx<0)return chord;return NOTES[(idx+shift)%12];}
function renderChords(){scroll.innerHTML=''; chords.forEach(c=>{const d=document.createElement('div'); d.className='chord'; d.textContent=c.chord; scroll.appendChild(d);});}

function toggleFull(){chordCard.classList.toggle('fullscreen');}
function format(t){const m=Math.floor(t/60); const s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`;}

// BPM detection placeholder (for demo, to replace with real analysis library)
function detectBPM(){
 bpm=90; // demo default, replace with analysis
 tempoDisplay.textContent=bpm+' BPM';
}

// tick-tock metronome
function startTempo(){
 if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 tempoActive=true;
 const interval=60000/bpm;
 tempoInterval=setInterval(()=>{
  if(!audio.paused){
   const osc=audioCtx.createOscillator();
   osc.frequency.value=1000;
   const gain=audioCtx.createGain(); gain.gain.value=0.2;
   osc.connect(gain); gain.connect(audioCtx.destination);
   osc.start(); osc.stop(audioCtx.currentTime+0.05);
   scrollChords();
  }
 },interval);
}
function stopTempo(){clearInterval(tempoInterval); tempoActive=false;}
tempoBtn.onclick=()=>{if(!tempoActive) startTempo(); else stopTempo();}
</script>
</body>
</html>
